#!/usr/bin/env bash
set -eo pipefail

echo "-----> Installing Tor"

TOR_VERSION=0.2.9.8
TOR_BASENAME="tor-${TOR_VERSION}"
TOR_ARCHIVE="https://dist.torproject.org/${TOR_BASENAME}.tar.gz"

# make a temp directory
tempdir="$( mktemp -t tor_XXXX )"
rm -rf $tempdir
mkdir -p $tempdir

pushd $tempdir
echo "-----> Downloading Tor"
curl -s -L -o tmp-tor.tar.gz $TOR_ARCHIVE
echo "-----> Extracting Tor"
tar -zxvf tmp-tor.tar.gz > /dev/null
rm tmp-tor.tar.gz
popd

mkdir -p $BUILD_DIR/.heroku/tor
pushd $BUILD_DIR/.heroku/tor
rm -rf tor-build
mv $tempdir/$TOR_BASENAME tor-build
pushd tor-build
echo "-----> Building Tor"
./configure --prefix=$BUILD_DIR/.heroku/tor > /dev/null 2>&1
make > /dev/null 2>&1
make install > /dev/null 2>&1
popd
rm -rf tor-build
popd

ln -s -f ../../tor/bin/tor .heroku/php/bin/tor
ln -s -f ../../tor/bin/tor-gencert .heroku/php/bin/tor-gencert
ln -s -f ../../tor/bin/torify .heroku/php/bin/torify
ln -s -f ../../tor/bin/tor-resolve .heroku/php/bin/tor-resolve

# Cache builds to avoid unnecessary wait times.
echo $TOR_ARCHIVE > $CACHE_DIR/.src-dist

# create tmptorrc take hostname and host.onion

echo "-----> Finished installing tor"

cat > ${BUILD_DIR}/tor/bin/hide <<EOF
#!/usr/bin/env bash
mkdir -p "${HOME}/hidden_service"
echo "Setting up hidden service"
cat > ${HOME}/hidden_service/private_key <<EPK
\${HIDDEN_PRIVATE_KEY}
EPK
echo \${HIDDEN_DOT_ONION} > ${HOME}/hidden_service/hostname
echo "HiddenServiceDir ${HOME}/hidden_service/" > $HOME/tor/torrc
echo "HiddenServicePort 80 127.0.0.1:\${PORT}" >> $HOME/tor/torrc
# Use -f to be safe here.
tor -f $HOME/tor/torrc &
exec \$*
EOF
chmod a+x ${BUILD_DIR}/bin/hide
ln -s -f ../../tor/bin/hide .heroku/php/bin/hide

echo "-----> tor hide shell create"
